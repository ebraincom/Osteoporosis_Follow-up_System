# 骨质疏松症随访系统 - 技术架构文档

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                    用户访问层                                │
├─────────────────────────────────────────────────────────────┤
│  机构用户(医护人员)     │    个人用户(患者)                  │
│  - 患者管理            │    - 个人信息管理                  │
│  - 随访设置            │    - 随访记录查看                  │
│  - 数据分析            │    - 健康数据录入                  │
│  - 报告生成            │    - AI健康咨询                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   前端展示层 (Vue 3)                        │
├─────────────────────────────────────────────────────────────┤
│  - Vue 3 + TypeScript + Composition API                    │
│  - Element Plus UI组件库                                   │
│  - Pinia状态管理                                          │
│  - Vue Router路由管理                                     │
│  - Axios HTTP客户端                                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   网关层 (Nginx)                           │
├─────────────────────────────────────────────────────────────┤
│  - 反向代理                                              │
│  - 静态文件服务                                          │
│  - 负载均衡                                              │
│  - SSL终止                                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   应用服务层 (FastAPI)                      │
├─────────────────────────────────────────────────────────────┤
│  - FastAPI Web框架                                        │
│  - Pydantic数据验证                                       │
│  - SQLAlchemy ORM                                         │
│  - JWT认证                                                │
│  - CORS中间件                                             │
│  - 异常处理                                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据访问层                                │
├─────────────────────────────────────────────────────────────┤
│  - CRUD操作                                               │
│  - 数据验证                                               │
│  - 事务管理                                               │
│  - 连接池管理                                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据存储层 (SQLite)                       │
├─────────────────────────────────────────────────────────────┤
│  - 用户表 (users)                                         │
│  - 个人用户表 (personal_users)                            │
│  - 患者表 (patients)                                      │
│  - 随访表 (followups)                                     │
│  - 随访响应表 (followup_responses)                        │
│  - 报告表 (reports)                                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 前端技术架构

### 1. 技术栈
- **Vue 3**: 渐进式JavaScript框架
- **TypeScript**: 类型安全的JavaScript超集
- **Element Plus**: Vue 3 UI组件库
- **Pinia**: Vue 3状态管理库
- **Vue Router**: Vue官方路由管理器
- **Axios**: HTTP客户端库
- **Vite**: 现代化构建工具

### 2. 项目结构
```
frontend/
├── src/
│   ├── api/                 # API接口层
│   │   ├── auth.ts         # 认证相关API
│   │   ├── user.ts         # 用户相关API
│   │   ├── patient.ts      # 患者相关API
│   │   ├── followup.ts     # 随访相关API
│   │   └── followupResponse.ts
│   ├── components/         # 公共组件
│   │   ├── AddPatientForm.vue
│   │   ├── HistoryDetailDialog.vue
│   │   └── PatientDetailView.vue
│   ├── composables/        # 组合式函数
│   │   ├── useHistory.ts
│   │   └── usePatients.ts
│   ├── router/            # 路由配置
│   │   └── index.ts
│   ├── stores/            # 状态管理
│   │   └── user.ts
│   ├── types/             # 类型定义
│   │   ├── user.ts
│   │   ├── patient.ts
│   │   └── history.ts
│   ├── utils/             # 工具函数
│   │   └── request.ts
│   ├── views/             # 页面组件
│   │   ├── Login.vue
│   │   ├── Register.vue
│   │   ├── Dashboard.vue
│   │   └── dashboard/
│   │       ├── Home.vue
│   │       ├── Analytics.vue
│   │       ├── Assessment.vue
│   │       ├── EMR.vue
│   │       ├── followup/
│   │       ├── personal-followup/
│   │       ├── data-collection/
│   │       ├── ai/
│   │       └── settings/
│   ├── App.vue
│   ├── main.ts
│   └── style.css
├── public/
├── index.html
├── package.json
├── vite.config.ts
└── tsconfig.json
```

### 3. 核心功能模块

#### 3.1 认证模块
```typescript
// 用户类型定义
interface User {
  id: number
  username: string
  name: string
  email?: string
  phone?: string
  user_type: 'institutional' | 'personal'
  institution?: string
  department?: string
  age?: number
  gender?: 'male' | 'female'
  avatar?: string
  created_at: string
  updated_at?: string
  is_active: boolean
  is_verified: boolean
}

// 认证状态管理
const userStore = useUserStore()
```

#### 3.2 路由守卫
```typescript
// 路由权限控制
router.beforeEach((to, from, next) => {
  const token = localStorage.getItem('token')
  const user = JSON.parse(localStorage.getItem('user') || '{}')
  
  if (to.meta.requiresAuth && !token) {
    next('/login')
  } else if (to.meta.userType && user.user_type !== to.meta.userType) {
    next('/dashboard')
  } else {
    next()
  }
})
```

#### 3.3 API请求拦截
```typescript
// 请求拦截器
request.interceptors.request.use((config) => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// 响应拦截器
request.interceptors.response.use(
  (response) => response.data,
  (error) => {
    if (error.response?.status === 401) {
      userStore.logout()
      router.push('/login')
    }
    return Promise.reject(error)
  }
)
```

---

## 后端技术架构

### 1. 技术栈
- **FastAPI**: 现代、快速的Python Web框架
- **SQLAlchemy**: Python SQL工具包和ORM
- **Pydantic**: 数据验证和设置管理
- **JWT**: JSON Web Token认证
- **Uvicorn**: ASGI服务器
- **Python 3.8+**: 编程语言

### 2. 项目结构
```
backend-python/
├── app/
│   ├── api/                # API路由层
│   │   └── v1/
│   │       ├── api.py      # 主路由
│   │       └── endpoints/  # 具体端点
│   │           ├── auth.py
│   │           ├── personal_auth.py
│   │           ├── users.py
│   │           ├── patients.py
│   │           ├── followups.py
│   │           ├── followup_responses.py
│   │           ├── analytics.py
│   │           └── ai_qa.py
│   ├── core/               # 核心配置
│   │   ├── config.py       # 配置文件
│   │   ├── config_simple.py
│   │   ├── database.py     # 数据库配置
│   │   └── security.py     # 安全相关
│   ├── crud/               # 数据访问层
│   │   ├── user.py
│   │   ├── personal_user.py
│   │   ├── patient.py
│   │   ├── followup.py
│   │   └── followup_response.py
│   ├── models/             # 数据模型
│   │   ├── user.py
│   │   ├── personal_user.py
│   │   ├── patient.py
│   │   ├── followup.py
│   │   └── followup_response.py
│   ├── schemas/            # 数据模式
│   │   ├── user.py
│   │   ├── personal_user.py
│   │   ├── patient.py
│   │   ├── followup.py
│   │   └── followup_response.py
│   └── __init__.py
├── main.py                 # 应用入口
├── requirements.txt        # 依赖包
└── Dockerfile             # Docker配置
```

### 3. 核心功能模块

#### 3.1 认证系统
```python
# JWT Token生成
def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

# 用户认证依赖
def get_current_user_dependency(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):
    # 支持机构用户和个人用户认证
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="无法验证凭据",
        headers={"WWW-Authenticate": "Bearer"},
    )
    
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception
    
    # 查询机构用户表
    user = db.query(User).filter(User.username == username).first()
    if user is None:
        # 查询个人用户表
        personal_user = db.query(PersonalUser).filter(PersonalUser.username == username).first()
        if personal_user is None:
            raise credentials_exception
        return personal_user
    return user
```

#### 3.2 数据模型
```python
# 机构用户模型
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String, unique=True, index=True, nullable=False)
    email = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String, nullable=False)
    name = Column(String, nullable=False)
    phone = Column(String)
    institution = Column(String)
    department = Column(String)
    is_active = Column(Boolean, default=True)
    is_verified = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# 个人用户模型
class PersonalUser(Base):
    __tablename__ = "personal_users"
    
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String, unique=True, index=True, nullable=False)
    hashed_password = Column(String, nullable=False)
    name = Column(String, nullable=False)
    phone = Column(String)
    age = Column(Integer)
    gender = Column(Enum(Gender))
    institution = Column(String)
    is_active = Column(Boolean, default=True)
    is_verified = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

#### 3.3 API端点
```python
# 个人用户认证端点
@router.post("/register", response_model=PersonalUserLoginResponse)
def register_personal_user(user: PersonalUserCreate, db: Session = Depends(get_db)):
    """个人用户注册"""
    # 检查用户名是否已存在
    db_user = get_personal_user_by_username(db, username=user.username)
    if db_user:
        raise HTTPException(
            status_code=400,
            detail="用户名已存在"
        )
    
    # 创建用户
    hashed_password = get_password_hash(user.password)
    db_user = PersonalUser(
        username=user.username,
        hashed_password=hashed_password,
        name=user.name,
        phone=user.phone,
        age=user.age,
        gender=user.gender,
        institution=user.institution
    )
    
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    
    # 生成访问令牌
    access_token_expires = timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
    access_token = create_access_token(
        data={"sub": db_user.username}, expires_delta=access_token_expires
    )
    
    return PersonalUserLoginResponse(
        access_token=access_token,
        token_type="bearer",
        user=db_user
    )
```

---

## 数据库设计

### 1. 数据库架构
```sql
-- 机构用户表
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR UNIQUE NOT NULL,
    email VARCHAR UNIQUE NOT NULL,
    hashed_password VARCHAR NOT NULL,
    name VARCHAR NOT NULL,
    phone VARCHAR,
    institution VARCHAR,
    department VARCHAR,
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 个人用户表
CREATE TABLE personal_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username VARCHAR UNIQUE NOT NULL,
    hashed_password VARCHAR NOT NULL,
    name VARCHAR NOT NULL,
    phone VARCHAR,
    age INTEGER,
    gender VARCHAR CHECK(gender IN ('male', 'female')),
    institution VARCHAR,
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 患者表
CREATE TABLE patients (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR NOT NULL,
    age INTEGER,
    gender VARCHAR CHECK(gender IN ('male', 'female')),
    phone VARCHAR,
    email VARCHAR,
    medical_record_number VARCHAR,
    diagnosis VARCHAR,
    treatment_history TEXT,
    created_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users (id)
);

-- 随访表
CREATE TABLE followups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title VARCHAR NOT NULL,
    description TEXT,
    patient_id INTEGER,
    created_by INTEGER,
    status VARCHAR DEFAULT 'active',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (patient_id) REFERENCES patients (id),
    FOREIGN KEY (created_by) REFERENCES users (id)
);

-- 随访响应表
CREATE TABLE followup_responses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    followup_id INTEGER,
    patient_id INTEGER,
    response_data TEXT,
    submitted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (followup_id) REFERENCES followups (id),
    FOREIGN KEY (patient_id) REFERENCES patients (id)
);
```

### 2. 数据关系
- **用户关系**: 机构用户 ↔ 患者 (一对多)
- **随访关系**: 机构用户 ↔ 随访 (一对多)
- **响应关系**: 患者 ↔ 随访响应 (一对多)
- **关联关系**: 随访 ↔ 随访响应 (一对多)

---

## 部署架构

### 1. 服务器配置
```yaml
# docker-compose.yml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    volumes:
      - ./frontend/dist:/usr/share/nginx/html
    depends_on:
      - backend

  backend:
    build: ./backend-python
    ports:
      - "8000:8000"
    volumes:
      - ./backend-python:/app
    environment:
      - DATABASE_URL=sqlite:///./osteoporosis.db
    depends_on:
      - database

  database:
    image: sqlite:latest
    volumes:
      - ./database:/data
```

### 2. Nginx配置
```nginx
server {
    listen 80;
    server_name localhost;
    
    # 前端静态文件
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api/ {
        proxy_pass http://backend:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 3. 环境配置
```python
# config_simple.py
class Settings:
    # 数据库配置
    DATABASE_URL: str = "sqlite:///./osteoporosis.db"
    
    # 安全配置
    SECRET_KEY: str = "your-secret-key"
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 30
    
    # CORS配置
    ALLOWED_HOSTS: List[str] = [
        "localhost",
        "127.0.0.1",
        "117.50.198.126",
        "*"
    ]
    
    # 其他配置
    DEBUG: bool = True
    PROJECT_NAME: str = "骨质疏松症随访系统"
```

---

## 安全机制

### 1. 认证安全
- **JWT Token**: 无状态认证机制
- **密码加密**: BCrypt密码哈希
- **Token过期**: 自动Token过期机制
- **刷新Token**: Token刷新机制

### 2. 数据安全
- **输入验证**: Pydantic数据验证
- **SQL注入防护**: SQLAlchemy ORM防护
- **XSS防护**: 前端输入过滤
- **CSRF防护**: CSRF Token机制

### 3. 网络安全
- **HTTPS**: SSL/TLS加密传输
- **CORS**: 跨域资源共享控制
- **防火墙**: 网络访问控制
- **IP白名单**: IP访问限制

---

## 性能优化

### 1. 前端优化
- **代码分割**: 路由级别的代码分割
- **懒加载**: 组件懒加载
- **缓存策略**: 浏览器缓存优化
- **压缩优化**: 资源压缩

### 2. 后端优化
- **异步处理**: FastAPI异步支持
- **数据库优化**: 查询优化和索引
- **缓存机制**: Redis缓存
- **连接池**: 数据库连接池

### 3. 系统优化
- **负载均衡**: Nginx负载均衡
- **CDN加速**: 静态资源CDN
- **监控告警**: 系统监控
- **日志管理**: 结构化日志

---

## 监控与维护

### 1. 系统监控
- **服务状态**: 服务运行状态监控
- **性能指标**: CPU、内存、磁盘监控
- **错误日志**: 错误日志收集
- **用户行为**: 用户行为分析

### 2. 数据备份
- **自动备份**: 定期数据备份
- **版本控制**: Git版本管理
- **灾难恢复**: 灾难恢复方案
- **数据迁移**: 数据迁移工具

### 3. 维护更新
- **版本管理**: 系统版本管理
- **热更新**: 无停机更新
- **回滚机制**: 快速回滚
- **测试环境**: 测试环境管理

---

*本文档最后更新时间: 2024年12月*
*系统版本: v1.0*
*文档版本: v1.0*