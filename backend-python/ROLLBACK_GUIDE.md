# 骨质疏松症随访系统 - 回滚机制使用指南

## 📋 概述

本系统提供了完整的回滚机制，确保在出现问题时能够快速恢复到稳定状态。

## 🚀 快速开始

### 1. 创建第一个备份

在开始任何重要修改前，先创建备份：

```bash
python version_control.py
# 选择 1. 创建备份
# 输入描述: "初始稳定版本"
# 输入文件路径: app/models/user.py,app/schemas/user.py,app/api/v1/endpoints/patients.py
# 确认备份数据库: y
```

### 2. 快速回滚

如果出现问题，使用快速回滚：

```bash
python quick_rollback.py
# 选择 1. 快速回滚
# 确认回滚
```

## 🔧 工具说明

### version_control.py - 版本控制工具

**功能：**
- 创建手动备份
- 管理版本历史
- 手动回滚到指定版本

**使用场景：**
- 重要功能开发前
- 重大修改前
- 需要精确控制版本时

### quick_rollback.py - 快速回滚工具

**功能：**
- 快速回滚到最新备份
- 紧急回滚到指定备份
- 自动备份当前状态

**使用场景：**
- 系统出现问题时
- 需要快速恢复时
- 紧急情况处理

### auto_backup.py - 自动备份工具

**功能：**
- 程序化创建备份
- 自动清理旧备份
- 集成到开发流程

**使用场景：**
- 自动化部署
- 持续集成
- 定期备份

## 📁 备份结构

```
backups/
├── v1_20250902_150000/          # 手动备份
│   ├── code/                     # 代码备份
│   │   ├── user.py
│   │   └── patients.py
│   └── database/                 # 数据库备份
│       └── osteoporosis.db
├── auto_feature_update_20250902_151000/  # 自动备份
│   ├── code/
│   └── database/
├── versions.json                 # 手动备份记录
└── auto_backups.json            # 自动备份记录
```

## 🎯 最佳实践

### 1. 备份时机

**必须备份的情况：**
- 修改数据库结构
- 修改核心业务逻辑
- 修改认证/权限系统
- 部署到生产环境前

**建议备份的情况：**
- 添加新功能
- 修改配置文件
- 更新依赖包

### 2. 备份策略

**手动备份：**
- 重要里程碑
- 重大功能完成
- 测试通过后

**自动备份：**
- 每次部署前
- 数据库迁移前
- 配置更改前

### 3. 回滚策略

**快速回滚：**
- 系统崩溃
- 功能异常
- 性能问题

**精确回滚：**
- 部分功能问题
- 需要特定版本
- 调试特定问题

## 🚨 紧急情况处理

### 系统完全无法启动

1. 使用紧急回滚：
```bash
python quick_rollback.py
# 选择 2. 紧急回滚
# 选择最近的稳定版本
```

2. 重启服务：
```bash
cmd /c start_all.bat
```

### 数据库损坏

1. 检查备份：
```bash
python version_control.py
# 选择 2. 列出版本
```

2. 恢复数据库：
```bash
python quick_rollback.py
# 选择 1. 快速回滚
```

### 代码问题

1. 回滚代码文件：
```bash
python version_control.py
# 选择 3. 回滚到指定版本
# 选择要回滚的版本
```

2. 重启服务验证

## 📊 监控和维护

### 定期检查

- 每周检查备份完整性
- 每月清理旧备份
- 每季度测试回滚流程

### 备份验证

- 验证备份文件完整性
- 测试回滚功能
- 检查备份空间

### 日志记录

- 记录所有备份操作
- 记录回滚操作
- 记录错误和异常

## 🔍 故障排除

### 常见问题

**备份失败：**
- 检查磁盘空间
- 检查文件权限
- 检查数据库连接

**回滚失败：**
- 确认备份文件存在
- 检查文件权限
- 验证备份完整性

**版本冲突：**
- 清理冲突文件
- 重新创建备份
- 手动解决冲突

### 联系支持

如果遇到无法解决的问题，请联系系统管理员或查看系统日志。

## 📝 更新日志

- 2025-09-02: 创建回滚机制
- 2025-09-02: 添加自动备份功能
- 2025-09-02: 完善使用文档

---

**记住：预防胜于治疗，定期备份是系统稳定性的重要保障！** 