# 骨质疏松症随访系统 - 部署运维文档

## 部署环境要求

### 1. 服务器要求
- **操作系统**: Linux (Ubuntu 20.04+ / CentOS 7+)
- **CPU**: 2核心以上
- **内存**: 4GB以上
- **存储**: 50GB以上可用空间
- **网络**: 公网IP，开放80、443、8000端口

### 2. 软件依赖
- **Python**: 3.8+
- **Node.js**: 16+
- **Nginx**: 1.18+
- **Git**: 2.0+
- **Docker**: 20.0+ (可选)

---

## 部署步骤

### 1. 环境准备

#### 1.1 更新系统
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

#### 1.2 安装基础软件
```bash
# Ubuntu/Debian
sudo apt install -y python3 python3-pip nodejs npm nginx git curl wget

# CentOS/RHEL
sudo yum install -y python3 python3-pip nodejs npm nginx git curl wget
```

#### 1.3 创建项目目录
```bash
sudo mkdir -p /opt/osteoporosis-system
sudo chown $USER:$USER /opt/osteoporosis-system
cd /opt/osteoporosis-system
```

### 2. 代码部署

#### 2.1 克隆代码仓库
```bash
git clone https://github.com/your-repo/osteoporosis-system.git .
```

#### 2.2 后端部署
```bash
# 进入后端目录
cd backend-python

# 安装Python依赖
pip3 install -r requirements.txt

# 初始化数据库
python3 -c "from app.core.database import engine; from app.models import *; Base.metadata.create_all(bind=engine)"

# 启动后端服务
python3 main.py &
```

#### 2.3 前端部署
```bash
# 进入前端目录
cd ../frontend

# 安装Node.js依赖
npm install

# 构建生产版本
npm run build

# 复制构建文件到Nginx目录
sudo cp -r dist/* /var/www/html/
```

### 3. Nginx配置

#### 3.1 创建Nginx配置
```bash
sudo nano /etc/nginx/sites-available/osteoporosis
```

#### 3.2 Nginx配置内容
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或IP
    
    # 前端静态文件
    location / {
        root /var/www/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # API代理到后端
    location /api/ {
        proxy_pass http://127.0.0.1:8000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 3.3 启用配置
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/osteoporosis /etc/nginx/sites-enabled/

# 删除默认配置
sudo rm /etc/nginx/sites-enabled/default

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
sudo systemctl enable nginx
```

### 4. 系统服务配置

#### 4.1 创建后端服务
```bash
sudo nano /etc/systemd/system/osteoporosis-backend.service
```

#### 4.2 服务配置内容
```ini
[Unit]
Description=Osteoporosis Follow-up System Backend
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/osteoporosis-system/backend-python
Environment=PATH=/usr/bin:/usr/local/bin
ExecStart=/usr/bin/python3 main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 4.3 启动服务
```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动后端服务
sudo systemctl start osteoporosis-backend
sudo systemctl enable osteoporosis-backend

# 检查服务状态
sudo systemctl status osteoporosis-backend
```

---

## 运维管理

### 1. 服务管理

#### 1.1 启动服务
```bash
# 启动后端服务
sudo systemctl start osteoporosis-backend

# 启动Nginx
sudo systemctl start nginx

# 检查服务状态
sudo systemctl status osteoporosis-backend
sudo systemctl status nginx
```

#### 1.2 停止服务
```bash
# 停止后端服务
sudo systemctl stop osteoporosis-backend

# 停止Nginx
sudo systemctl stop nginx
```

#### 1.3 重启服务
```bash
# 重启后端服务
sudo systemctl restart osteoporosis-backend

# 重启Nginx
sudo systemctl restart nginx
```

### 2. 日志管理

#### 2.1 查看服务日志
```bash
# 查看后端服务日志
sudo journalctl -u osteoporosis-backend -f

# 查看Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

#### 2.2 日志轮转配置
```bash
sudo nano /etc/logrotate.d/osteoporosis
```

```bash
/var/log/osteoporosis/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload osteoporosis-backend
    endscript
}
```

### 3. 数据备份

#### 3.1 数据库备份
```bash
#!/bin/bash
# backup_database.sh

BACKUP_DIR="/opt/backups/osteoporosis"
DATE=$(date +%Y%m%d_%H%M%S)
DB_FILE="/opt/osteoporosis-system/backend-python/osteoporosis.db"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
cp $DB_FILE $BACKUP_DIR/osteoporosis_$DATE.db

# 压缩备份文件
gzip $BACKUP_DIR/osteoporosis_$DATE.db

# 删除30天前的备份
find $BACKUP_DIR -name "*.db.gz" -mtime +30 -delete

echo "数据库备份完成: osteoporosis_$DATE.db.gz"
```

#### 3.2 代码备份
```bash
#!/bin/bash
# backup_code.sh

BACKUP_DIR="/opt/backups/code"
DATE=$(date +%Y%m%d_%H%M%S)
PROJECT_DIR="/opt/osteoporosis-system"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份代码
tar -czf $BACKUP_DIR/osteoporosis_code_$DATE.tar.gz -C $PROJECT_DIR .

# 删除30天前的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "代码备份完成: osteoporosis_code_$DATE.tar.gz"
```

#### 3.3 自动备份配置
```bash
# 添加到crontab
crontab -e

# 每天凌晨2点备份数据库
0 2 * * * /opt/osteoporosis-system/scripts/backup_database.sh

# 每周日凌晨3点备份代码
0 3 * * 0 /opt/osteoporosis-system/scripts/backup_code.sh
```

### 4. 监控配置

#### 4.1 系统监控脚本
```bash
#!/bin/bash
# monitor_system.sh

# 检查后端服务状态
if ! systemctl is-active --quiet osteoporosis-backend; then
    echo "后端服务异常，正在重启..."
    systemctl restart osteoporosis-backend
    # 发送告警邮件
    echo "后端服务已重启" | mail -s "系统告警" admin@example.com
fi

# 检查Nginx状态
if ! systemctl is-active --quiet nginx; then
    echo "Nginx服务异常，正在重启..."
    systemctl restart nginx
    # 发送告警邮件
    echo "Nginx服务已重启" | mail -s "系统告警" admin@example.com
fi

# 检查磁盘空间
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "磁盘空间不足: ${DISK_USAGE}%" | mail -s "系统告警" admin@example.com
fi

# 检查内存使用
MEMORY_USAGE=$(free | awk 'NR==2{printf "%.2f", $3*100/$2}')
if (( $(echo "$MEMORY_USAGE > 80" | bc -l) )); then
    echo "内存使用率过高: ${MEMORY_USAGE}%" | mail -s "系统告警" admin@example.com
fi
```

#### 4.2 监控定时任务
```bash
# 每5分钟检查一次系统状态
*/5 * * * * /opt/osteoporosis-system/scripts/monitor_system.sh
```

---

## 故障排除

### 1. 常见问题

#### 1.1 后端服务无法启动
```bash
# 检查Python依赖
pip3 list | grep fastapi

# 检查端口占用
netstat -tlnp | grep 8000

# 查看详细错误日志
sudo journalctl -u osteoporosis-backend -n 50
```

#### 1.2 前端页面无法访问
```bash
# 检查Nginx状态
sudo systemctl status nginx

# 检查Nginx配置
sudo nginx -t

# 检查端口占用
netstat -tlnp | grep 80
```

#### 1.3 数据库连接问题
```bash
# 检查数据库文件权限
ls -la /opt/osteoporosis-system/backend-python/osteoporosis.db

# 检查数据库文件完整性
sqlite3 /opt/osteoporosis-system/backend-python/osteoporosis.db ".schema"
```

### 2. 性能优化

#### 2.1 数据库优化
```sql
-- 创建索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_personal_users_username ON personal_users(username);
CREATE INDEX idx_patients_created_by ON patients(created_by);
CREATE INDEX idx_followups_patient_id ON followups(patient_id);

-- 分析查询性能
EXPLAIN QUERY PLAN SELECT * FROM users WHERE username = 'test';
```

#### 2.2 Nginx优化
```nginx
# 在nginx.conf中添加
worker_processes auto;
worker_connections 1024;

# 启用gzip压缩
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

# 启用缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 3. 安全加固

#### 3.1 防火墙配置
```bash
# Ubuntu/Debian
sudo ufw enable
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS
sudo ufw deny 8000   # 禁止直接访问后端

# CentOS/RHEL
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --reload
```

#### 3.2 SSL证书配置
```bash
# 使用Let's Encrypt免费证书
sudo apt install certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

---

## 更新升级

### 1. 代码更新

#### 1.1 更新流程
```bash
# 1. 备份当前版本
/opt/osteoporosis-system/scripts/backup_code.sh

# 2. 拉取最新代码
cd /opt/osteoporosis-system
git pull origin master

# 3. 更新后端依赖
cd backend-python
pip3 install -r requirements.txt

# 4. 重启后端服务
sudo systemctl restart osteoporosis-backend

# 5. 更新前端
cd ../frontend
npm install
npm run build
sudo cp -r dist/* /var/www/html/

# 6. 重启Nginx
sudo systemctl restart nginx
```

#### 1.2 数据库迁移
```bash
# 如果有数据库结构变更，执行迁移
cd /opt/osteoporosis-system/backend-python
python3 -c "from app.core.database import engine; from app.models import *; Base.metadata.create_all(bind=engine)"
```

### 2. 版本回滚

#### 2.1 快速回滚
```bash
# 1. 停止服务
sudo systemctl stop osteoporosis-backend

# 2. 恢复代码
cd /opt/osteoporosis-system
git reset --hard HEAD~1

# 3. 恢复数据库
cp /opt/backups/osteoporosis/osteoporosis_latest.db.gz /tmp/
gunzip /tmp/osteoporosis_latest.db.gz
cp /tmp/osteoporosis_latest.db backend-python/osteoporosis.db

# 4. 重启服务
sudo systemctl start osteoporosis-backend
```

---

## 维护检查清单

### 1. 日常检查
- [ ] 服务运行状态
- [ ] 系统资源使用情况
- [ ] 日志文件大小
- [ ] 数据库文件完整性
- [ ] 网络连接状态

### 2. 周度检查
- [ ] 备份文件完整性
- [ ] 系统安全更新
- [ ] 性能指标分析
- [ ] 用户反馈收集
- [ ] 错误日志分析

### 3. 月度检查
- [ ] 系统性能优化
- [ ] 安全漏洞扫描
- [ ] 数据清理
- [ ] 容量规划
- [ ] 灾难恢复测试

---

## 联系信息

### 技术支持
- **邮箱**: support@example.com
- **电话**: 400-xxx-xxxx
- **工作时间**: 周一至周五 9:00-18:00

### 紧急联系
- **24小时热线**: 138-xxxx-xxxx
- **紧急邮箱**: emergency@example.com

---

*本文档最后更新时间: 2024年12月*
*系统版本: v1.0*
*文档版本: v1.0*